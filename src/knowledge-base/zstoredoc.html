<!doctype html>
<html lang="en">
    <head>
        {{> head}}
    </head>

    <body class="body">
        <div class="website">
            {{> header}}

            <!-- content -->
            <main class="content">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <article class="article">
                                <h1>Документація розробника</h1>

                                <ul class="page-nav">
                                    <li><a href="#id1">Архітектура</a></li>
                                    <li>
                                        <a href="#id2">Структура даних інформаційної системи</a>
                                    </li>
                                    <li><a href="#id3">Структура основних об'єктів</a></li>
                                    <li><a href="#id4">Інтеграція з іншими системами</a></li>
                                    <li><a href="#id5">Опис таблиць БД</a></li>
                                </ul>

                                <h2 id="id1">Архітектура</h2>

                                <h3>Архітектура програми</h3>

                                <p>
                                    З точки зору програми, облікова система базується на
                                    архітектурі, яка визначається фреймворком Zippy. У зв'язку з
                                    чим, розробнику слід ознайомиться зі сторінками проектів
                                    <a href="https://zippy.com.ua/frm">Фреймворк Zippy</a> і
                                    <a href="https://zippy.com.ua/zdb"> Zippy DB</a>.
                                </p>

                                <p>
                                    Стилі програми засновані на Twitter Bottstrap. Верстка сторінки,
                                    бічне меню та інше зроблено на адмінці AdminLTE2.
                                </p>

                                <p>
                                    У загальному випадку сторінку можна умовно розділити на бекенд і
                                    фронтенд. Бекенд - це PHP файл (папка pages), фронтенд - шаблон
                                    (папка templates/pages). Також у шаблонах є папка printforms із
                                    шаблонами друкованих форм документів та звітів. Файл бекенда по
                                    суті є комбінацією контролера та моделі - методи є методами
                                    контролера, що реагують на події фронтенда, тобто на дії
                                    Користувача, а поля та zippy-компоненти - це модель, що зберігає
                                    стан сторінки.
                                </p>

                                <p>
                                    Існує кілька варіантів взаємодії між фронтендом і бекендом, які
                                    можуть використовуватися як окремо, так і в комбінації один з
                                    одним.
                                </p>

                                <h4>Через компоненти zippy</h4>

                                <p>
                                    Використовується для двостороннього обміну між фронтендом та
                                    бекендом. Насамперед із елементами введення з форм, а також для
                                    виведення таблиць, в яких є елементи виклику методів бекенда
                                    (наприклад, іконки редагування). У цьому випадку
                                    фронтенд-компонент прив'язується через атрибут zippy до бекенд
                                    частини компонента та забезпечує двосторонній обмін даними,
                                    реакцію на події, а також персистентність стану сторінки,
                                    оскільки сторінка разом з компонентами та їх даними кешуються в
                                    сесії, та відновлюється після перезавантаження. Крім цього,
                                    основні компоненти мають вбудовану можливість обробки подій
                                    (викликів бекенду) за допомогою ajax запитів без
                                    перезавантаження сторінки.
                                </p>

                                <h4>За допомогою шаблонізатора Mustache</h4>

                                <p>
                                    Якщо виведення даних одностороннє, тобто тільки у бік фронтенду
                                    і не передбачає введення даних (наприклад показати/приховати
                                    якийсь блок залежно від даних, вивести якусь інформацію і т.д.),
                                    використовується шаблонізатор Mustache, який працює за типом
                                    шаблонізаторів Twig або Smarty. Таке рішення набагато простіше,
                                    ніж за допомогою компонентів Zippy. Дані шаблонізатора додаються
                                    в поле сторінки - масив $this->_tvars. Також за допомогою
                                    Mustache рендеруються друковані форми документів та звітів.
                                </p>

                                <h4>Запити від javascript фреймворків</h4>

                                <p>
                                    Для обробки запитів, не пов'язаних із подіями компонентів zippy,
                                    передбачено виклик методів сторінок за ім'ям. Для цього слід
                                    використовувати javascript функцію callpagemethod, яка йде з
                                    фреймворком та формує правильний url для виклику сторінки. Метод
                                    розташований у /vendor/leon-mbs/zippy/assets/js/zippy-bundle.js.
                                    Зазвичай на фронті використовується бібліотека jquery або, у
                                    складніших випадках (наприклад, віджет перегляду документа або
                                    сторінка нарахування зарплати), фреймворк Vue, але може бути
                                    використание будь-яке Javascript рішення.
                                </p>

                                <h3>Архітектура бiзнес-логiки</h3>

                                <p>
                                    Програма складається з двох базових частин - ядра з загальними
                                    сторінками і функціональністю (користувачі, управління системою
                                    і т.д.) і, власне, облікової частини куди входять об'єкти
                                    метаданих (документи, довідники, звіти), що реалізують основну
                                    бізнес-логіку. У термінах 1С можна умовно назвати ці частини
                                    платформою і конфігурацією.
                                </p>

                                <p>
                                    Основа облікової частини - об'єкти метаданих (довідники,
                                    документи, звіти, журнали). Об'єкти спроектовані з мінімальною
                                    залежністю один від одного і доступні через загальне меню, яке
                                    будується динамічно, згідно зі списком об'єктів, що задається
                                    адміністратором. Це дозволяє незалежно модифікувати їх без зміни
                                    інших об'єктів і модулів системи. Розробники за аналогією з
                                    конструктором Lego можуть легко створювати різні конфігурації (в
                                    термінології 1С) під різні типи бізнесу, обмінюватися
                                    реалізацією окремих об'єктів системи та друкованими формами
                                    простим копіюванням файлів.
                                </p>

                                <p>
                                    Алгоритми бізнес-логіки реалізуються безпосередньо на мові PHP.
                                    Шаблони (бланки) друкованих форм документів і звітів виконані в
                                    чистому HTML, що дозволяє як друкувати їх безпосередньо, так і
                                    експортувати в Word, Excel або PDF, а також коригувати їх за
                                    допомогою звичайного текстового редактора.
                                </p>

                                <h3>Організація даних</h3>

                                <p><strong>Основні бізнес-сутності:</strong></p>

                                <div class="page-table">
                                    <table class="table table-striped">
                                        <tbody>
                                            <tr>
                                                <td><b>ТМЦ</b></td>
                                                <td>товари, матеріали, продукція</td>
                                            </tr>
                                            <tr>
                                                <td><b>Склади</b></td>
                                                <td>склади, магазини</td>
                                            </tr>
                                            <tr>
                                                <td><b>Контрагенти</b></td>
                                                <td>постачальники, покупці</td>
                                            </tr>
                                            <tr>
                                                <td><b>Документи</b></td>
                                                <td>
                                                    первинні документи фіксують господарські
                                                    операції
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <p>
                                    У відповідності з архітектурою фреймворка, всі бізнес-суті
                                    реалізовані класами, наслідуваними від
                                    <a
                                        href="http://zippy.com.ua/apiZCL.DB.Entity.html"
                                        target="_blank"
                                        ><code>Entity</code></a
                                    >.
                                </p>

                                <h2 id="id2">Структура даних інформаційної системи</h2>

                                <p>
                                    <strong>Аналітичний облік</strong> ведеться на підставі руху
                                    матеріальних і грошових коштів, відповідно до господарських
                                    операцій. Система не зберігає початкові і поточні залишки за
                                    період (використовується повний перерахунок рухів). Це спрощує
                                    огранізацію даних і дозволяє вводити і змінювати інформацію
                                    заднім числом, а також переднім, що дозволяє виконувати
                                    резервування товару і планування операцій.
                                </p>

                                <p>
                                    Аналітичні дані зберігаються в одній таблиці entrylist. По суті,
                                    таблиці фактів в ROLAP де вимірювання - бізнес-сутності.
                                    Збільшення запасів відображається записом з позитивними
                                    значеннями кількості і суми, зменшення - негативними, таким
                                    чином залишки і обороти по товару виходять простим
                                    підсумовуванням за період.
                                </p>

                                <p>
                                    Також аналітичні дані, як і дані, що посилаються на інші
                                    бізнес-суті, зберігаються в самому документі в упакованому
                                    вигляді. Подібна денормалізація дозволяє уникнути додаткових
                                    звернень до БД, а також дозволяє зберігати "історичні" дані в
                                    документі - документ зберігає всі атрибути такими, якими вони
                                    були на момент створення документа.
                                </p>

                                <p>
                                    <strong>Складський облік</strong> ведеться по партіях. Партія -
                                    той же товар за тією ж обліковою ціною (ціна надходження)
                                    незалежно від постачальника. Записи по рухах на складі
                                    зберігаються в таблиці store_stock, де крім посилання на склад і
                                    на ТМЦ вказана облікова ціна (партія).
                                </p>

                                <h2 id="id3">Структура основних об'єктів</h2>

                                <h3>Довідники</h3>

                                <p>
                                    Елементи довідників - об'єкти, що знаходяться в просторі імен
                                    <code>App\Entity</code>. Об'єкти призначені для зберігання
                                    довідкових бізнес-сутностей. Для редагування переліків об'єктів
                                    призначені відповідні сторінки в просторі імен
                                    <code>App\Pages\Reference</code>.
                                </p>

                                <h3>Звіти</h3>

                                <p>
                                    Сторінки звітів знаходяться в просторі імен
                                    <code>App\Pages\Report</code>. З кожним звітом пов'язана
                                    друкована форма, яка знаходиться в папці
                                    <code>/templates/printforms</code>
                                </p>

                                <h3>Журнали</h3>

                                <p>
                                    Журнали об'єднують об'єкти та бізнес-сутності за типом
                                    використання. Наприклад - журнал документів, журнал замовлень.
                                    Сторінки журналів знаходяться в просторі імен
                                    <code>App\Pages\Register</code>.
                                </p>

                                <h3>Документи</h3>

                                <p>
                                    Для кожного типу документа реалізований клас в просторі імен
                                    <code>App\Entity\Doc</code>, успадкований від базового класу
                                    <code>Document</code>. Клас документа реалізує бізнес-логіку
                                    відповідно до типу госп. операції і забезпечує зберігання
                                    документа в БД. З кожним типом документа пов'язані сторінка
                                    редагування документа в просторі імен
                                    <code>App\Pages\Doc</code> і шаблон друкованої форми в папці
                                    <code>/templates/printforms</code>.
                                </p>

                                <p>
                                    Кожен клас документа передбачає два методи:
                                    <code>generateReport</code> и <code>Execute</code>. Метод
                                    <code>generateReport</code> призначений для заповнення
                                    друкованої форми даними документа. Метод
                                    <code>Execute</code> змінює данні аналітичного обліку - фіксує
                                    рух матеріальних і грошових коштів. За збереження документа в БД
                                    та інші загальні операції над усіма типами документів відповідає
                                    базовий клас <code>Document</code>.
                                </p>

                                <p>
                                    Всі документи зберігаються в одній таблиці. Таблиця містить
                                    кілька загальних полів (наприклад: дати, номер документа) і
                                    текстове поле content де зберігається деталізація документа у
                                    вигляді XML. Використання XML дозволяє, при необхідності,
                                    виконувати пошук за документами, орієнтуючись на XML теги, а
                                    також використовувати <code>XPath</code>. Упаковку і
                                    розпаковування детальних даних документа виконує базовий клас.
                                    Для цього клас містить масив <code>$headerdata</code> для шапки
                                    та таблиць частини документа. Сторінка редагування документа
                                    повинна записувати атрибути до цього масиву. Таблична частина
                                    пакується в одне з полів, наприклад
                                    $doc->packDetails('detaildata', $itemlist);
                                </p>

                                <p>
                                    Деякі поля загального признаяення,яких слід притримуватись для
                                    сумісності документів та правильної работи бізнес-логіки .
                                </p>

                                <div class="page-table">
                                    <table class="table table-striped">
                                        <tbody>
                                            <tr>
                                                <td>headerdata['author']</td>
                                                <td>Автор (створювач) документа</td>
                                            </tr>
                                            <tr>
                                                <td>user_id</td>
                                                <td>
                                                    Користувач ассоційований з документом. За
                                                    замовчанням- автор
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>customer_id</td>
                                                <td>Коннтрагент (якщо заданий)</td>
                                            </tr>
                                            <tr>
                                                <td>branch_id</td>
                                                <td>Філія,якщо ввімкнена підтримка</td>
                                            </tr>
                                            <tr>
                                                <td>firm_id</td>
                                                <td>Компанія</td>
                                            </tr>
                                            <tr>
                                                <td>parent_id</td>
                                                <td>Батьківський документ (підства)</td>
                                            </tr>
                                            <tr>
                                                <td>state</td>
                                                <td>Статус</td>
                                            </tr>
                                            <tr>
                                                <td>headerdata['store']</td>
                                                <td>id складу</td>
                                            </tr>
                                            <tr>
                                                <td>headerdata['time']</td>
                                                <td>Час (document_date має тільки дату)</td>
                                            </tr>
                                            <tr>
                                                <td>headerdata['payment']</td>
                                                <td>
                                                    id грошового рахунку для оплати (каса, банк)
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>amount</td>
                                                <td>Сума по документу (по позиціях)</td>
                                            </tr>
                                            <tr>
                                                <td>payamount</td>
                                                <td>
                                                    Сума дл сплати (amount мінус наприклад знижка)
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>payed</td>
                                                <td>Фактична оплата (сума по таблиці платажів)</td>
                                            </tr>
                                            <tr>
                                                <td>headerdata['payed']</td>
                                                <td>
                                                    Внесена оплата. Для відповідного поля на
                                                    сторінці редагування документу. Може не
                                                    збігатись з payed наприклад при частковій оплаті
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>headerdata['detaildata']</td>
                                                <td>Упакована таблична частина.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <p>
                                    Всі об'єкти зареєстровані в таблиці метаданих на відповідній
                                    сторінці налаштувань. По таблиці метаданих автоматично
                                    формується меню. У таблиці вказується тип, назва об'єкта, ім'я
                                    класу (простір імен обчислюється за типом), група (для другого
                                    рівня меню).
                                </p>

                                <h4>Приклад створення документа</h4>

                                <p>
                                    Припустимо потрібно додати в систему документ
                                    Товарно-транспортна накладна. Необхідно внести запис в метадані,
                                    створити сторінку редагування документа, клас-сутність для
                                    зберігання документа в БД і HTML шаблон друкованої форми.
                                </p>

                                <p><strong>Необхідна послідовність:</strong></p>

                                <ul>
                                    <li>
                                        Створюємо в просторі імен <code>App\Entity\Doc</code> клас
                                        сутності <code>TTN</code>, успадкований від класу
                                        <code>Document</code>.
                                    </li>
                                    <li>
                                        Перевизначити методи <code>generateReport</code> і
                                        <code>Execute</code>. Метод <code>Execute</code> виконує
                                        відповідні записи в таблиці аналітичного обліку. Метод
                                        <code>generateReport</code> звертається до генератора
                                        звітів, передаючи йому шаблон друкованої форми і дані з
                                        деталізації документа, створюючи на виході HTML файл із
                                        заповненим бланком для друку або експорту.
                                    </li>
                                    <li>
                                        Файл з класом сутності копіюємо в каталог
                                        <code>/app/entity/doc/</code>
                                    </li>
                                    <li>
                                        Створюємо сторінку редагування документа. Сторінка
                                        створюється з ім'ям класу <code>BankStatement</code> в
                                        просторі імен <code>App\Pages\Doc</code> як звичайна
                                        сторінка відповідно з архітектурою фреймворка Zippy. Файл з
                                        класом сторінки створюємо в каталозі
                                        <code>app/pages/doc</code>, шаблон сторінки - в каталозі
                                        <code>/templates/pages/doc</code>.
                                    </li>
                                    <li>
                                        Створюємо файл ttn.tpl з друкарською формою в каталозі
                                        <code>/templates/printforms</code>.
                                    </li>
                                    <li>
                                        Додаємо запис для документа на сторінці налаштування меню з
                                        ім'ям класу TTN.
                                    </li>
                                    <li>
                                        Документ ТТН з'явиться в головному меню і буде готовий до
                                        використання.
                                    </li>
                                </ul>

                                <h2 id="id4">Інтеграція з іншими системами</h2>

                                <p>
                                    У програмі передбачено API для інтеграції з зовнішніми
                                    системами. Вбудований готовий набір функцій виконаний на основі
                                    JSON-RPC. Опис функцій знаходиться за адресою /api/help. Перед
                                    використанням в налаштуваннях системи необхідно вказати метод
                                    авторизації. API дозволяє працювати з довідниками товарів і
                                    контрагентів, створювати замовлення і відслідковувати їх статус.
                                </p>

                                <h2 id="id5">Опис таблиць БД</h2>

                                <p>
                                    Зміна даних напряму в таблиці не рекомендується. Більшість
                                    операцій виконується через відповідні Entity
                                </p>

                                <div class="page-table">
                                    <table class="table table-striped">
                                        <tbody>
                                            <tr>
                                                <td><b>branches</b></td>
                                                <td>Філії</td>
                                            </tr>
                                            <tr>
                                                <td><b>contracts</b></td>
                                                <td>Договори. Пов'язують компанію і контрагента</td>
                                            </tr>
                                            <tr>
                                                <td><b>crontask</b></td>
                                                <td>Завдання планувальника</td>
                                            </tr>
                                            <tr>
                                                <td><b>custacc</b></td>
                                                <td>
                                                    Балансові рахунки контрагентів. При проведенні
                                                    документу виконується рух по дебету обо кредиту.
                                                    Позитивнмй баланс - кредитовий борг фірми,
                                                    негативний - дебетовий. Також в таблиці
                                                    Зберігаются нараховані бонуси
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>custitems</b></td>
                                                <td>Товари у постачальника</td>
                                            </tr>
                                            <tr>
                                                <td><b>customers</b></td>
                                                <td>Контрагенти</td>
                                            </tr>
                                            <tr>
                                                <td><b>docstatelog</b></td>
                                                <td>Исторія статусів документіа</td>
                                            </tr>
                                            <tr>
                                                <td><b>documents</b></td>
                                                <td>
                                                    Документи. Поля: amount - сума по документу,
                                                    payamount - до сплаты, payed - оплачено (сума по
                                                    таблиці payments)
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>empacc</b></td>
                                                <td>
                                                    Особовий рахунок співробітника. В першу чергу
                                                    для руху по зарплаті.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>employees</b></td>
                                                <td>
                                                    CСпівробітники. Поле login з'єднує з
                                                    користувачем системи (аккаунтом)
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>entrylist</b></td>
                                                <td>Рух по складу</td>
                                            </tr>
                                            <tr>
                                                <td><b>equipments</b></td>
                                                <td>Основні засоби та обладнання</td>
                                            </tr>
                                            <tr>
                                                <td><b>eventlist</b></td>
                                                <td>
                                                    Події, використовуєтся для контрагентів і
                                                    завдань
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>files</b></td>
                                                <td>Загружені файли</td>
                                            </tr>
                                            <tr>
                                                <td><b>filesdata</b></td>
                                                <td>
                                                    Зміст файлів. Окрема таблиця щоб не грузити всю
                                                    БД
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>firms</b></td>
                                                <td>Компанії</td>
                                            </tr>
                                            <tr>
                                                <td><b>images</b></td>
                                                <td>Зображення</td>
                                            </tr>
                                            <tr>
                                                <td><b>iostate</b></td>
                                                <td>Записи прибутків та видатків</td>
                                            </tr>
                                            <tr>
                                                <td><b>issue_*</b></td>
                                                <td>Таблиці модуля Проекти та завдання</td>
                                            </tr>
                                            <tr>
                                                <td><b>item_cat</b></td>
                                                <td>Категорії (групи) ТМЦ</td>
                                            </tr>
                                            <tr>
                                                <td><b>item_set</b></td>
                                                <td>Комплекти для ТМЦ</td>
                                            </tr>
                                            <tr>
                                                <td><b>items</b></td>
                                                <td>Номенклатура ТМЦ</td>
                                            </tr>
                                            <tr>
                                                <td><b>keyval</b></td>
                                                <td>
                                                    Допоміжна таблиця для даних типу ключ-значення
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>messages</b></td>
                                                <td>Повідомлення</td>
                                            </tr>
                                            <tr>
                                                <td><b>metadata</b></td>
                                                <td>
                                                    Бізнес-об'єкти (документє, довідники, щвіти,
                                                    журналм... Формує меню програми)
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>mfund</b></td>
                                                <td>Грошові рахунки рахунки</td>
                                            </tr>
                                            <tr>
                                                <td><b>note_*</b></td>
                                                <td>Таблиці модуля Органайзер</td>
                                            </tr>
                                            <tr>
                                                <td><b>notifies</b></td>
                                                <td>Повідомлення</td>
                                            </tr>
                                            <tr>
                                                <td><b>options</b></td>
                                                <td>
                                                    Загальні налаштування та налаштування модулів
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>parealist</b></td>
                                                <td>Виробничі дільниці</td>
                                            </tr>
                                            <tr>
                                                <td><b>paylist</b></td>
                                                <td>Оплати (рух по грошових рахунках)</td>
                                            </tr>
                                            <tr>
                                                <td><b>poslist</b></td>
                                                <td>POS термінали</td>
                                            </tr>
                                            <tr>
                                                <td><b>prodproc</b></td>
                                                <td>Виробничі процеси</td>
                                            </tr>
                                            <tr>
                                                <td><b>prodstage</b></td>
                                                <td>Виробничі етапм</td>
                                            </tr>
                                            <tr>
                                                <td><b>prodstageagenda</b></td>
                                                <td>Розклад этапів</td>
                                            </tr>
                                            <tr>
                                                <td><b>promocodes</b></td>
                                                <td>Промо коди</td>
                                            </tr>
                                            <tr>
                                                <td><b>roles</b></td>
                                                <td>Ролі користувачів</td>
                                            </tr>
                                            <tr>
                                                <td><b>saltypes</b></td>
                                                <td>Типи нарахувань та утримань по зарплаті</td>
                                            </tr>
                                            <tr>
                                                <td><b>services</b></td>
                                                <td>Послуги, роботи</td>
                                            </tr>
                                            <tr>
                                                <td><b>shop_*</b></td>
                                                <td>Таблиці онлайн-каталогу</td>
                                            </tr>
                                            <tr>
                                                <td><b>stats</b></td>
                                                <td>Службова таблиця для статистичних даних</td>
                                            </tr>
                                            <tr>
                                                <td><b>store_stock</b></td>
                                                <td>
                                                    Партії товарів. Пов'язує товар, склади та
                                                    облікові ціни. Поле qty (кількість)
                                                    вираховується за допомогою триггерів при зміні
                                                    таблиці entrylist Поле partion - облікова ціна.
                                                    Додаткова розбивка якщо ввімкнений облік по
                                                    серіях
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><b>stores</b></td>
                                                <td>Склади</td>
                                            </tr>
                                            <tr>
                                                <td><b>subscribes</b></td>
                                                <td>Підписки</td>
                                            </tr>
                                            <tr>
                                                <td><b>taglist</b></td>
                                                <td>Теги</td>
                                            </tr>
                                            <tr>
                                                <td><b>timesheet</b></td>
                                                <td>Облік робочого часу</td>
                                            </tr>
                                            <tr>
                                                <td><b>users</b></td>
                                                <td>
                                                    Користувачі системи. admin - невидялюваний
                                                    користувач
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
            </main>
            <!-- end content -->

            {{> footer}}
        </div>

        {{> contacts-form}}

        {{> scripts}}
    </body>
</html>
